# Generate latest build and push it to dockerhub on push to develop branch.
# NOTE: This workflow does not include any tests, nor any dependencies, since bors guarantees
# that only code that passes all tests is ever pushed to develop.
name: Push to Dockerhub
run-name: Pushing ${{ github.ref_name }} to Dockerhub
env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

on:
  push:
    branches:
      - develop
    tags:
      - '*'

jobs:
  dockerpush:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v3
    - name: Build docker images
      run: |
        make dockerbuild-go
        make dockerbuild-bs
    - name: Push docker images to dockerhub dev repo
      run: |
        if [[ "${{ github.ref }}" == "refs/tags/"* ]]; then
          echo "DOCKER_IMAGE_VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
        fi
        make dockerpush-only
        make dockerpush-bs-only
    - name: Push docker images to dockerhub release repo
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        "DOCKER_IMAGE_REPO=go-spacemesh" make dockerpush-only
        "DOCKER_IMAGE_REPO=go-spacemesh" make dockerpush-bs-only
