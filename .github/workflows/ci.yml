name: CI

env:
  go-version: '1.14.6'
  GCLOUD_KEY: ${{ secrets.GCLOUD_KEY }}
  PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
  CLUSTER_NAME: ${{ secrets.CLUSTER_NAME }}
  CLUSTER_ZONE: ${{ secrets.CLUSTER_ZONE }}
  ES_PASSWD: ${{ secrets.ES_PASSWD }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

# Trigger the workflow on all pull requests, and on push to specific branches
on:
  pull_request:
    # Don't trigger tests if only updating docs
    paths-ignore:
      - '**.md'
  push:
    branches:
      - staging
      - trying
    # Don't trigger tests if only updating docs
    paths-ignore:
      - '**.md'

jobs:
  # stage 1: run these as a prerequisite as they're quick and cheap
  quicktests:
    runs-on: ubuntu-latest
    steps:
     - name: checkout
       uses: actions/checkout@v2
     - name: set up go
       uses: actions/setup-go@v2
       with:
         go-version: ${{ env.go-version }}
     - name: fmt, tidy, lint
       run: |
         make
         make genproto
         make test-tidy
         make test-fmt
         make lint

  # stage 2: next run unit tests and app tests in parallel
  unittests:
    runs-on: ubuntu-latest
    needs: quicktests
    steps:
     - name: checkout
       uses: actions/checkout@v2
     - name: set up go
       uses: actions/setup-go@v2
       with:
         go-version: ${{ env.go-version }}
     - name: setup env
       run: make
     - name: unit tests (except app test)
       run: make test-no-app-test
  apptests:
    runs-on: ubuntu-latest
    needs: quicktests
    steps:
     - name: checkout
       uses: actions/checkout@v2
     - name: set up go
       uses: actions/setup-go@v2
       with:
         go-version: ${{ env.go-version }}
     - name: setup env
       run: make
     - name: app test
       run: make test-only-app-test

  # stage 3: next run docker push, as system tests rely on this
  dockerpush:
    # only run on push, not on pull_request
    # note that this does NOT run on pushes to branch develop, see separate workflow file for that
    if: github.event_name == 'push'
    needs:
      - unittests
      - apptests
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: push to dockerhub
        run: make dockerpush

  # stage 4: finally run system tests in parallel if everything else passes
  systemtest-latenodes:
    # only run on push, not on pull_request
    if: github.event_name == 'push'
    needs: dockerpush
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: late nodes system test
        run: make dockertest-late-nodes
  systemtest-blocks-add-node:
    # only run on push, not on pull_request
    if: github.event_name == 'push'
    needs: dockerpush
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: blocks add node test
        run: make dockertest-blocks-add-node
  systemtest-hare-mining:
    # only run on push, not on pull_request
    if: github.event_name == 'push'
    needs: dockerpush
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: hare+mining system tests
        run: make dockertest-hare-mining
  systemtest-sync-blocks:
    # only run on push, not on pull_request
    if: github.event_name == 'push'
    needs: dockerpush
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: sync+blocks remove node test
        run: make dockertest-sync-blocks-remove-node
  systemtest-genesis-p2p:
    # only run on push, not on pull_request
    if: github.event_name == 'push'
    needs: dockerpush
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: genesis+p2p system tests
        run: make dockertest-genesis-voting-p2p
